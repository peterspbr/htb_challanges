# Baby Time Capsule writeup
> By Peter (thetaphase), jul 7, 2024

## CHALLENGE DESCRIPTION
Qubit Enterprises is a new company touting it's propriety method of qubit stabilization. They expect to be able to build a quantum computer that can factor a RSA-1024 number in the next 10 years. As a promotion they are giving out "time capsules" which contain a message for the future encrypted by 1024 bit RSA. They might be great engineers, but they certainly aren't cryptographers, can you find a way to read the message without having to wait for their futuristic machine?

## Basic info

**Cryptographic system: RSA**

**Key size: 1024**

**Public exponent e: 5 (that's really weak)**

This challange involves generating what they call Time Capsules. Each time capsule contains the encrypted flag that we need.

When i connected to the server, it brings me the following:

```bash
nc -v 94.237.49.120 30341                                                                                                   
Connection to 94.237.49.120 30341 port [tcp/*] succeeded!
Welcome to Qubit Enterprises. Would you like your own time capsule? (Y/n) y
{"time_capsule": "FD02431CE61CDF0999DFAF74C1381039C24CB93B69C552CD7C46E8F66C0DE8CEDDF789009AC27D68A32AB6129E8B806BBAAD797C35BC9B21D173BA777139620D6DD73EFEE5C4774E007AA5F9A9A34634ADC5DA006DC76512ACC4A848B97249D9562327DBBF91FA5EEAC98AA85CE7C38414F91AE87FF8186626D810349E519E4", "pubkey": ["93D57188770D6D701113CCD71F0BA0984AD82D7DBC854DF53F2C536605A88058DF3D1A69CB66610EB51904E794E57AB5EC544DDA2208F0E704A71B5648A1456C2FC99659EE4E723279E955CBE3CA1C81028FF7B83BA82FE87D7F0D45B03AAAAE405E17B335EAFAF981AB481214B84290866724E56D53D5B51BB657A5BB133277", "5"]}
Welcome to Qubit Enterprises. Would you like your own time capsule? (Y/n) y
{"time_capsule": "3E81387E9583CA75F81FBA397C261C6D191183A0A0CAF4DAFA2437D3908E9D84B84E23CC9401F0BCCDE7DCCC1411C4C6B5E22028E252CE39D71CC9D2160C7BE05B70A893B99094F2CDD4120A83D0D13C75C76E8DF379ADDDAFCE010436D9943D9565D5F4390A7F1A0307F3FAEF32B517D038FD9348F04E64343F5444A6105F01", "pubkey": ["D6DF5799B7B73D39070DAAB6DB477D3F3C85093F088995A3B74930507CC6458E0391CA977207733CA24D0542DF69B3952F60F69A31C695582791774B6460B9885B79A9A2CBCBD4CEF7A67FFED9B309661841133EDD088952940107C3085A0DB55D9BDA09CDC4661C773EF77D0C81319002471478A868B8A251A7D7F43E30B83F", "5"]}
Welcome to Qubit Enterprises. Would you like your own time capsule? (Y/n) y
{"time_capsule": "AA906797DDCE7E8865722036FB3EAA28BAA86C357A85CD0E10C8E5734C9798D6A6441FC218E5C69207B113EA07E0DA5F39BC4ED8C5CDAC41E345BF6BBAB84401A7D1F18BA594D9AAE593E8150F192AC154B3E89055E4D46970C8BA069FD8661C915183CBB49481807789948D05E4E6CFFC48D4135D0C408263BA2BA4704370F", "pubkey": ["65AD73E56DA25E0E6E093EA441AD4626CCEDD930A12C28B44E776BE44A06F97CEC8014964357AFBCF7A9AD3FA9B86601DAADAAE56BF1F70AF0E32C9007D4AB193A6D2203E40A87F4E955210D193067F05837A98FEAE10BABC645D4C955BDA9227987777AE05C870142DDA7B3704BEE8B74FB65BB01D60E68A40DFCCE74326671", "5"]}
Welcome to Qubit Enterprises. Would you like your own time capsule? (Y/n) n
Thank you, take care
```

## Encrypted flags:
We take 3 samples of the flag.

## Hexa:

Message 1: `FD02431CE61CDF0999DFAF74C1381039C24CB93B69C552CD7C46E8F66C0DE8CEDDF789009AC27D68A32AB6129E8B806BBAAD797C35BC9B21D173BA777139620D6DD73EFEE5C4774E007AA5F9A9A34634ADC5DA006DC76512ACC4A848B97249D9562327DBBF91FA5EEAC98AA85CE7C38414F91AE87FF8186626D810349E519E4`

Message 2: `3E81387E9583CA75F81FBA397C261C6D191183A0A0CAF4DAFA2437D3908E9D84B84E23CC9401F0BCCDE7DCCC1411C4C6B5E22028E252CE39D71CC9D2160C7BE05B70A893B99094F2CDD4120A83D0D13C75C76E8DF379ADDDAFCE010436D9943D9565D5F4390A7F1A0307F3FAEF32B517D038FD9348F04E64343F5444A6105F01`

Message 3: `AA906797DDCE7E8865722036FB3EAA28BAA86C357A85CD0E10C8E5734C9798D6A6441FC218E5C69207B113EA07E0DA5F39BC4ED8C5CDAC41E345BF6BBAB84401A7D1F18BA594D9AAE593E8150F192AC154B3E89055E4D46970C8BA069FD8661C915183CBB49481807789948D05E4E6CFFC48D4135D0C408263BA2BA4704370F`

## Decimal:
Message 1: `11104302943014764115980183765377122155671041745928183308303496779324543712434548256863082084728588502577652261433218882793222363885521565773973057234007741921467481663213877718093326432452708953391384158343047355677141467188705680688120903926503658483389419433606447094557408457424800984067422054183235557860`

Message 2: `43892340955480913825504955364865966103379995638895460427668866411166605616607623728478796928337345372827443183571729610571536978587769134152233810142631950846768443514055883157023219325905043901681187392005784184486138763736552009906401356178445712671537481634391892005441023294142311299170248551654482796289`

Message 3: `7485885667516311030526639638971768588866967039095004603597876473433277020592513856842295685962504561940337976374736689800100207027697061339116227774353182672983558069905456714574061813847623301463212507358576915804727918184151967540216049419171417054355917039115106083332265175529362019083840271175618148111`

## n
The moduli n.
## Hexa:
Message 1: `93D57188770D6D701113CCD71F0BA0984AD82D7DBC854DF53F2C536605A88058DF3D1A69CB66610EB51904E794E57AB5EC544DDA2208F0E704A71B5648A1456C2FC99659EE4E723279E955CBE3CA1C81028FF7B83BA82FE87D7F0D45B03AAAAE405E17B335EAFAF981AB481214B84290866724E56D53D5B51BB657A5BB133277`

Message 2: `D6DF5799B7B73D39070DAAB6DB477D3F3C85093F088995A3B74930507CC6458E0391CA977207733CA24D0542DF69B3952F60F69A31C695582791774B6460B9885B79A9A2CBCBD4CEF7A67FFED9B309661841133EDD088952940107C3085A0DB55D9BDA09CDC4661C773EF77D0C81319002471478A868B8A251A7D7F43E30B83F`

Message 3: `65AD73E56DA25E0E6E093EA441AD4626CCEDD930A12C28B44E776BE44A06F97CEC8014964357AFBCF7A9AD3FA9B86601DAADAAE56BF1F70AF0E32C9007D4AB193A6D2203E40A87F4E955210D193067F05837A98FEAE10BABC645D4C955BDA9227987777AE05C870142DDA7B3704BEE8B74FB65BB01D60E68A40DFCCE74326671`

## Decimal:
Message 1: `103812399208329155329776395253697481607813373129732668633034654894224520379857913842927745773403509708623428218488777555924453471174767437685305112615705977604548349903441628926965819681485665227833079264839621932707658446166146409297723772205437252494618022979428293538015677757886137387564554731868740858487`
Message 2: `150888551972531018619022429944270504178782392348689622130267027417410456132886952976198104277869045295804352595123494434621875793514886091016331859154758892394526201832845140245619349403694367998970174353462555711611404105856549917412359300882052095569269253089314789648258043915401825101460935578630063437887`
Message 3: `71400403531118179269188411051263141621200146946055905080761251980209540803597138622664143958621120429050174820961589001236082099269286815451797236565523916418845821734257244701423880820503786275335417960880875422755084382580651885340805440681853203374825990950301733803629857391810322186401137580744004232817`

The value of e = 5. That's really small. We usually work with the value 65537 for it's computational advantages.
> e = 5

## Decrypting
As we can notice, the ciphertext and moduli ùëõ is different for each iteration, but the public exponent ùëí remains the same. This can lead us to the RSA Small Public Exponent Attack, often called Hastad's Broadcast Attack. This attack exploits the scenario where the same plaintext message is sent to multiple recipients who share the same small public exponent ùëí but different moduli ùëõ. Using the Chinese Remainder Theorem (CRT), one can recover the plaintext message efficiently.

The following script implements these:

```python
import gmpy2
from functools import reduce

def chinese_remainder_theorem(items):
    N = reduce(lambda a, b: a*b, [item[0] for item in items])
    result = 0
    for n_i, a_i in items:
        N_i = N // n_i
        inv = gmpy2.invert(N_i, n_i)
        result += a_i * inv * N_i
    return result % N

def rsa_small_public_exponent_attack(ciphers, moduli, e):
    items = [(moduli[i], ciphers[i]) for i in range(len(ciphers))]
    x = chinese_remainder_theorem(items)
    m_e = gmpy2.iroot(x, e)[0]  # Taking the e-th root to get the original message
    return int(m_e)

def int_to_bytes(n):
    return n.to_bytes((n.bit_length() + 7) // 8, byteorder='big')

# Example usage
if __name__ == "__main__":
    # Example ciphertexts and moduli
    ciphers = [
        11104302943014764115980183765377122155671041745928183308303496779324543712434548256863082084728588502577652261433218882793222363885521565773973057234007741921467481663213877718093326432452708953391384158343047355677141467188705680688120903926503658483389419433606447094557408457424800984067422054183235557860,
        43892340955480913825504955364865966103379995638895460427668866411166605616607623728478796928337345372827443183571729610571536978587769134152233810142631950846768443514055883157023219325905043901681187392005784184486138763736552009906401356178445712671537481634391892005441023294142311299170248551654482796289,
        7485885667516311030526639638971768588866967039095004603597876473433277020592513856842295685962504561940337976374736689800100207027697061339116227774353182672983558069905456714574061813847623301463212507358576915804727918184151967540216049419171417054355917039115106083332265175529362019083840271175618148111
    ]
    moduli = [
        103812399208329155329776395253697481607813373129732668633034654894224520379857913842927745773403509708623428218488777555924453471174767437685305112615705977604548349903441628926965819681485665227833079264839621932707658446166146409297723772205437252494618022979428293538015677757886137387564554731868740858487,
        150888551972531018619022429944270504178782392348689622130267027417410456132886952976198104277869045295804352595123494434621875793514886091016331859154758892394526201832845140245619349403694367998970174353462555711611404105856549917412359300882052095569269253089314789648258043915401825101460935578630063437887,
        71400403531118179269188411051263141621200146946055905080761251980209540803597138622664143958621120429050174820961589001236082099269286815451797236565523916418845821734257244701423880820503786275335417960880875422755084382580651885340805440681853203374825990950301733803629857391810322186401137580744004232817
    ]
    e = 5
    
    message_int = rsa_small_public_exponent_attack(ciphers, moduli, e)
    message_bytes = int_to_bytes(message_int)
    
    try:
        message_text = message_bytes.decode('utf-8')
        print(f"Recovered message: {message_text}")
    except UnicodeDecodeError:
        print("The recovered message could not be decoded as UTF-8. Here is the raw byte string:")
        print(message_bytes)
```

Running this script gives us the flag for the challange! Good luck.